function loadReadability(){return"undefined"==typeof Readability?(console.warn("Readability.js not available in global scope"),!1):(console.log("Readability.js available in global scope"),!0)}let hasSentResult=!1;function sendScrapeResult(e){if(hasSentResult)return void logger.debug("sendScrapeResult called again, ignoring");hasSentResult=!0;const t="scrape_result"+(windowLabel?`_${windowLabel}`:"");logger.debug(`send ${t} , data: `,e?.success||e?.error),sendEvent(t,e)}(()=>{const e=["https://www.bing.com/ck/","https://www.so.com/link","https://sogou.com/link","https://www.sogou.com/link"],t=()=>!!window.location.href&&(window.location.href.startsWith("http://")||window.location.href.startsWith("https://"))&&!e.some(e=>window.location.href.startsWith(e));function r(e,t){const r=e.querySelector(t.selector);if(!r)return null;switch(t.type){case"attribute":{const e=r.getAttribute(t.attribute);return["href","src","srcset","data-src","poster","action"].includes(t.attribute)&&r[t.attribute]||e}case"html":return r.innerHTML?.trim();case"markdown":return(new TurndownService).turndown(baseCleanForMarkdown(r));default:return formatText(r.innerText)}}async function n(e){try{if(!e.selectors?.base_selector)return hasSentResult?void 0:sendScrapeResult({error:"selectors.base_selector is required"});if(console.log("base_selector:",e.selectors.base_selector),e.config?.wait_for){console.log("wait_for:",e.config.wait_for);try{await function(e,t=1e4){return new Promise((r,n)=>{const o=document.querySelector(e);if(o)return r(o);const a=new MutationObserver(()=>{const t=document.querySelector(e);t&&(a.disconnect(),r(t))});a.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{a.disconnect(),n(new Error(`Timeout waiting for element: ${e}`))},t)})}(e.config.wait_for,e.config.wait_timeout||1e4)}catch(e){return void(hasSentResult||sendScrapeResult({error:`Wait for element failed: ${e.message}`}))}}const t=[],n=3;let o=0;for(;o<n;){const n=document.querySelectorAll(e.selectors.base_selector);if(n.length){n.forEach(n=>{console.log("element:",n);const o={};let a=!0;e.selectors.fields.forEach(e=>{o[e.name]=r(n,e),e.required&&!o[e.name]&&(a=!1)}),a&&t.push(o)});break}o++,await new Promise(e=>setTimeout(e,1e3*2**o))}console.info("scrape with schema result:",t?.length),hasSentResult||sendScrapeResult({success:JSON.stringify(t)})}catch(e){logger.error("Schema scraping failed:",e),hasSentResult||sendScrapeResult({error:`Schema scraping failed: ${e.message}`})}}async function o(){try{if(!loadReadability())throw new Error("Readability.js not available");const e=document.cloneNode(!0),t=new Readability(e,{url:window.location.href}).parse();if(console.log("Readability extracted content, length:",t?.content?.length||0),!t||!t.content||t.content.length<100)throw console.warn("Readability extracted insufficient content, length:",t?.content?.length||0),new Error("Readability extracted insufficient content");return{title:t.title||document.title,content:t.content,excerpt:t.excerpt,byline:t.byline,length:t.length,readingTime:t.readingTime}}catch(e){throw console.warn("Readability extraction failed, falling back to custom extractor:",e.message),e}}window.performScrape=async(e,r)=>{hasSentResult=!1,logger.debug("performScrape called, config:",JSON.stringify(e)),logger.debug("generic_content_rule:",JSON.stringify(r));try{await new Promise((e,r)=>{const n=setInterval(()=>{"undefined"!=typeof TurndownService&&t()&&(clearInterval(n),logger.debug("TurndownService is ready, url:",window.location.href),e())},100);setTimeout(()=>{clearInterval(n),r(new Error("Timeout waiting for TurndownService"))},3e3)}),e?await n(e):await async function(e={}){let t="Unknown error",r=!0;r&&loadReadability()&&"undefined"!=typeof Readability&&console.log("Readability.js available for content extraction");for(let n=0;n<3;n++)try{if(r&&0===n)try{const t=await o(),r=document.createElement("div");let n;if(r.innerHTML=t.content,!1===e.keep_image&&r.querySelectorAll("img").forEach(e=>{e.remove()}),!1===e.keep_link&&r.querySelectorAll("a").forEach(e=>{e.replaceWith(e.textContent)}),"text"===e.format?n=formatText(r.textContent||""):(n=new TurndownService({headingStyle:"atx",hr:"---",bulletListMarker:"*",codeBlockStyle:"fenced",emDelimiter:"_"}).turndown(r.innerHTML),n=n.replace(/\\\[(.*?)\]/g,"[$1]").replace(/\n{3,}/g,"\n\n").trim()),n.length<50)throw new Error("Readability extracted content too short");const a={title:t.title,content:n,url:window.location.href,byline:t.byline};return void(hasSentResult||sendScrapeResult({success:JSON.stringify(a)}))}catch(e){console.log("Readability failed, falling back to custom extractor:",e.message),r=!1}const t=document.title||document.querySelector("h1, h2, h3")?.innerText||"",a=document.body?.cloneNode(!0);if(!a)throw new Error("Content scraping failed, cannot find body child elements");const i="script, style, noscript, form, iframe, frame, object, embed, video, audio, link, svg, canvas, meta, head, base, template, symbol, button, select, textarea, datalist, dialog, source, picture, track, map";if(a.querySelectorAll(i).forEach(e=>{e.remove()}),"text"===e.format){a.querySelectorAll("nav, aside, header, footer").forEach(e=>{e.remove()});const e=formatText(a?.innerText||"");if(e.length<50)throw new Error(`Scraped text content is too short (${e.length} chars).`);return void(hasSentResult||sendScrapeResult({success:JSON.stringify({title:t,content:e,url:window.location.href})}))}if(e.keep_image?a.querySelectorAll("img")?.forEach(e=>{const t=e.src||e.getAttribute("src");if(!t||t.startsWith("data:")||t.startsWith("blob:"))return void e.remove();const r=document.createElement("img");r.src=t,r.alt=e.alt||"",e.replaceWith(r)}):a.querySelectorAll("img")?.forEach(e=>{e.remove()}),e.keep_link){const e=a.querySelectorAll("a");e?.forEach(e=>{const t=e.href;""===t||t.startsWith("#")||t.startsWith("javascript:")?e.removeAttribute("href"):e.setAttribute("href",t),e.innerText=e.innerText.trim().replace(/\n+/g," ")})}else{const e=a.querySelectorAll("a");e?.forEach(e=>{const t=document.createTextNode(e.innerText.replace(/\n+/g," ").trim());e.replaceWith(t)}),a.querySelectorAll("nav, aside, header, footer").forEach(e=>{e.remove()})}a.querySelectorAll(i).forEach(e=>{e.remove()});let l=new TurndownService({headingStyle:"atx",hr:"---",bulletListMarker:"*",codeBlockStyle:"fenced",emDelimiter:"_"}).turndown(a);if(l=l.replace(/\\\[(.*?)\]/g,"[$1]").replace(/\n{3,}/g,"\n\n").trim(),l.length<50)throw new Error(`Scraped markdown content is too short (${l.length} chars, raw text: ${l}).`);const c={title:t,content:l,url:window.location.href};return void(hasSentResult||sendScrapeResult({success:JSON.stringify(c)}))}catch(e){if(t=e.message,logger.error(`Scrape attempt ${n+1} failed: ${t}`),n<2){const e=1e3*2**n;logger.debug(`Waiting ${e}ms for next retry...`),await new Promise(t=>setTimeout(t,e))}}logger.error("Generic scraping failed after 3 attempts."),hasSentResult||sendScrapeResult({error:`Generic scraping failed after 3 attempts: ${t}`})}(r||{})}catch(e){logger.error("performScrape failed:",e),hasSentResult||sendScrapeResult({error:`performScrape failed: ${e.message}`})}},(async()=>{try{const e=await new Promise(e=>{if(window.__TAURI__?.event)logger.debug("Tauri api available"),e(window.__TAURI__.event);else{const t=setInterval(()=>{window.__TAURI__?.event&&(logger.debug("Tauri api available"),clearInterval(t),e(window.__TAURI__.event))},50);setTimeout(()=>{logger.warn("Tauri api not available after 5 secs."),clearInterval(t),e(null)},5e3)}});if(!e)return void logger.warn("Tauri API unavailable, unable to send event");const r=3;let n=0;for(;!t()&&n<r;)n++,await new Promise(e=>setTimeout(e,1e3*2**n));t()?(logger.info("emit page loaded, url:",window.location.href),e.emit(`page_loaded_${windowLabel}`)):logger.warn("Failed to get a valid URL after multiple retries.")}catch(e){logger.error("Error during page loaded event handling:",e)}})()})();