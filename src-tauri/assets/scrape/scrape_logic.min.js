function sendScrapeResult(e){const t="scrape_result"+(windowLabel?"_"+windowLabel:"");logger.debug("send "+t+" , data: ",e?.success||e?.error),sendEvent(t,e)}!function(){const e=["https://www.bing.com/ck/","https://www.so.com/link","https://sogou.com/link","https://www.sogou.com/link"],t=()=>!!window.location.href&&(window.location.href.startsWith("http://")||window.location.href.startsWith("https://"))&&!e.some(e=>window.location.href.startsWith(e));function r(e,t){const r=e.querySelector(t.selector);if(!r)return null;switch(t.type){case"attribute":const e=r.getAttribute(t.attribute);return["href","src","srcset","data-src","poster","action"].includes(t.attribute)&&r[t.attribute]||e;case"html":return r.innerHTML?.trim();case"markdown":return(new TurndownService).turndown(baseCleanForMarkdown(r));default:return formatText(r.innerText)}}async function o(e){try{if(!e.selectors?.base_selector)return sendScrapeResult({error:"selectors.base_selector is required"});if(console.log("base_selector:",e.selectors.base_selector),e.config?.wait_for){console.log("wait_for:",e.config.wait_for);try{await function(e,t=1e4){return new Promise((r,o)=>{const n=document.querySelector(e);if(n)return r(n);const a=new MutationObserver(()=>{const t=document.querySelector(e);t&&(a.disconnect(),r(t))});a.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{a.disconnect(),o(new Error(`Timeout waiting for element: ${e}`))},t)})}(e.config.wait_for,e.config.wait_timeout||1e4)}catch(e){return void sendScrapeResult({error:`Wait for element failed: ${e.message}`})}}const t=[],o=3;let n=0;for(;n<o;){const o=document.querySelectorAll(e.selectors.base_selector);if(o.length){o.forEach(o=>{console.log("element:",o);const n={};let a=!0;e.selectors.fields.forEach(e=>{n[e.name]=r(o,e),e.required&&!n[e.name]&&(a=!1)}),a&&t.push(n)});break}n++,await new Promise(e=>setTimeout(e,1e3*Math.pow(2,n)))}console.info("scrape with schema result:",t?.length),sendScrapeResult({success:JSON.stringify(t)})}catch(e){logger.error("Schema scraping failed:",e),sendScrapeResult({error:`Schema scraping failed: ${e.message}`})}}window.performScrape=async function(e,r){logger.debug("performScrape called, config:",JSON.stringify(e)),logger.debug("generic_content_rule:",JSON.stringify(r));try{await new Promise((e,r)=>{const o=setInterval(()=>{"undefined"!=typeof TurndownService&&t()&&(clearInterval(o),logger.debug("TurndownService is ready, url:",window.location.href),e())},100);setTimeout(()=>{clearInterval(o),r(new Error("Timeout waiting for TurndownService"))},3e3)}),e?await o(e):await async function(e={}){try{let t,r=document.title||document.querySelector("h1, h2, h3")?.innerText||"";const o=3;let n=0;for(;!t&&n<o;)t=document.body?.cloneNode(!0),t||(n++,await new Promise(e=>setTimeout(e,1e3*Math.pow(2,n))));if(!t)return logger.error("Content scraping failed"),void sendScrapeResult({error:"Content scraping failed, cannot find body child elements"});let a="script, style, noscript, form, iframe, frame, object, embed, video, audio, link, svg, canvas, meta, head, base, template, symbol, button, select, textarea, datalist, dialog, source, picture, track, map";if(t.querySelectorAll(a).forEach(e=>e.remove()),"text"===e.format){t.querySelectorAll("nav, aside, header, footer").forEach(e=>e.remove());const e=formatText(t?.innerText||"");return void sendScrapeResult({success:JSON.stringify({title:r,content:e,url:window.location.href})})}if(e.keep_image?t.querySelectorAll("img")?.forEach(e=>{const t=e.src||e.getAttribute("src");if(!t||t.startsWith("data:")||t.startsWith("blob:"))return void e.remove();const r=document.createElement("img");r.src=t,r.alt=e.alt||"",e.replaceWith(r)}):t.querySelectorAll("img")?.forEach(e=>e.remove()),e.keep_link){const e=t.querySelectorAll("a");e?.forEach(e=>{const t=e.href;""===t||t.startsWith("#")||t.startsWith("javascript:")?e.removeAttribute("href"):e.setAttribute("href",t),e.innerText=e.innerText.trim().replace(/\n+/g," ")})}else{const e=t.querySelectorAll("a");e?.forEach(e=>{const t=document.createTextNode(e.innerText.replace(/\n+/g," ").trim());e.replaceWith(t)}),t.querySelectorAll("nav, aside, header, footer").forEach(e=>e.remove())}t.querySelectorAll(a).forEach(e=>e.remove());let i=new TurndownService({headingStyle:"atx",hr:"---",bulletListMarker:"*",codeBlockStyle:"fenced",emDelimiter:"_"}).turndown(t);i=i.replace(/\\[(.*?)\\]/g,"[$1]").replace(/\n{3,}/g,"\n\n").trim();const c={title:r,content:i,url:window.location.href};sendScrapeResult({success:JSON.stringify(c)})}catch(e){logger.error("scrape generic failed:",e),sendScrapeResult({error:`Generic scraping failed: ${e.message}`})}}(r||{})}catch(e){logger.error("performScrape failed:",e),sendScrapeResult({error:`performScrape failed: ${e.message}`})}},(async()=>{try{const e=await new Promise(e=>{if(window.__TAURI__?.event)logger.debug("Tauri api available"),e(window.__TAURI__.event);else{const t=setInterval(()=>{window.__TAURI__?.event&&(logger.debug("Tauri api available"),clearInterval(t),e(window.__TAURI__.event))},50);setTimeout(()=>{logger.warn("Tauri api not available after 5 secs."),clearInterval(t),e(null)},5e3)}});if(!e)return void logger.warn("Tauri API unavailable, unable to send event");const r=3;let o=0;for(;!t()&&o<r;)o++,await new Promise(e=>setTimeout(e,1e3*Math.pow(2,o)));t()?(logger.info("emit page loaded, url:",window.location.href),e.emit("page_loaded_"+windowLabel)):logger.warn("Failed to get a valid URL after multiple retries.")}catch(e){logger.error("Error during page loaded event handling:",e)}})()}();