[简体中文](./RELEASE.zh-CN.md) ｜ [English](./RELEASE.md)

# 发布日志

## [1.2.5]

### 🪄 改进

- **启动路径鲁棒性与故障回退**：实现了“不崩溃”初始化策略。如果数据库因文件系统权限或损坏无法加载，程序现在会自动回退到 **内存数据库 (:memory:)**。这确保了应用即使在极端的环境配置下也能正常启动并提供诊断信息，而不是在引导阶段直接闪退。

### 🐞 修复

- **Windows 11 启动崩溃修复**：通过回退某些与特定线程模型冲突的 SQLite 打开标志（`SQLITE_OPEN_FULL_MUTEX`），解决了在 Windows 11 上的 Panic 问题。

---

## [1.2.4]

### 🪄 改进

- **数据库架构加固**：将数据库引擎升级为 **WAL (Write-Ahead Logging)** 模式，并实现了 5 秒的 **Busy Timeout (忙碌重试)**。这些改进显著提升了并发性能，允许后台代理 (CCProxy) 与主聊天界面同时访问数据库而不会发生锁定冲突。
- **备份数据完整性保障**：在执行任何备份操作前引入了强制的 **SQL Checkpoint (TRUNCATE)** 机制。这确保了所有最新的消息记录（原先可能暂存在 `-wal` 日志文件中）在加密前都被完整同步到数据库主文件中，解决了“备份不到最新消息”的问题。
- **状态保留的原子化还原**：彻底重构了数据库还原流程。系统现在执行安全的原子级“断开-替换-重连”序列，防止了文件损坏和重启崩溃。同时，在还原过程中能够自动保留机器特有的设置（如窗口位置、尺寸、网络代理配置等），确保数据迁移后的无缝体验。
- **关键稳定性硬化**：对应用程序启动序列进行了全面审计和重构。移除了所有在关键路径（如日志系统、数据库路径解析及窗口管理）中硬编码的 `.expect()` 和 `.unwrap()` 调用。这确保了在 Windows Server 2019 等权限高度受限的环境下，程序仍能平稳启动而不会闪退。
- **日志系统自动降级**：当日志目录不可写或无法访问时，日志系统现在会自动降级为仅控制台输出模式，彻底消除了由于磁盘写入权限导致的启动 Panic。

### 🐞 修复

- **生产环境数据库锁定修复**：解决了在生产环境下，由于初始化过程中冗余的文件句柄请求导致的“attempt to write a readonly database”关键错误。
- **代理路由优先级修复**：解决了通配分组路径（如 `/{group}/...`）可能意外拦截 `/switch`、`/compat` 或 `/compat_mode` 等特定功能前缀的冲突问题。该修复确保了所有访问模式都能正确分发，解决了组合路径下可能出现的 404 错误。
- **兼容模式别名支持**：新增了 `compat` 简写别名作为 `compat_mode` 的便捷替代方案（例如：`/group/compat/v1/messages`），提升了 API 调用体验。
- **代理统计校准**：修复了在 `工具兼容模式` (tool_compat_mode) 和 `直接转发` (direct_forward) mode 下，输出 Token 统计始终为 0 的问题。现在系统能准确估算所有协议（OpenAI、Claude、Gemini、Ollama）中的**推理/思考内容 (Reasoning/Thinking)** 及**工具调用参数**的 Token 消耗。
- **统一缓存 Token 追踪**：实现了跨协议的缓存 Token 统一映射。现在能正确捕捉并记录来自不同协议的缓存数据（如 OpenAI 的 `prompt_cached_tokens`、Claude 的 `cache_read_input_tokens` 以及 Gemini 的 `cached_content_tokens`），并确保其在流式响应结束时准确入库。
- **路径解析 Panic 修复**：解决了在部分受限环境下，若操作系统无法返回当前工作目录或应用数据目录时可能导致的 Panic。
- **窗口句柄竞态修复**：在注册全局窗口监听器时增加了安全性检查，防止在窗口尚未完全就绪的极早期启动阶段发生崩溃。

---

## [1.2.2]